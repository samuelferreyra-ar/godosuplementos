<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mi carrito</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
</head>
<body>
  <div class="container py-5">
    <h2 class="mb-4">Mi carrito</h2>
    <div id="carrito-lista">
      <!-- Aquí se cargan los productos del carrito -->
    </div>
    <div class="text-end mt-4">
      <button class="btn btn-success btn-lg" id="btn-comprar">Comprar</button>
    </div>
  </div>

  <script type="module">
    import { getCarritoLocal, setCantidadProducto, quitarDelCarritoLocal } from './js/carrito.js';
    import { auth, db } from './js/firebase.js';
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const carritoLista = document.getElementById("carrito-lista");

    async function renderCarrito() {
      carritoLista.innerHTML = `<div class="text-center text-muted">Cargando...</div>`;
      const productosCarrito = getCarritoLocal();
      if (productosCarrito.length === 0) {
        carritoLista.innerHTML = `<div class="text-center text-muted">Tu carrito está vacío.</div>`;
        document.getElementById("btn-comprar").disabled = true;
        return;
      }
      // Traer todos los productos (puedes optimizar trayendo solo los del carrito)
      const snap = await getDocs(collection(db, "productos"));
      const productosDB = [];
      snap.forEach(doc => productosDB.push({id: doc.id, ...doc.data()}));

      let total = 0;
      let html = `
        <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th></th>
              <th>Producto</th>
              <th>Categoría</th>
              <th>Precio</th>
              <th>Cantidad</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
      `;
      productosCarrito.forEach(item => {
        const prod = productosDB.find(p => p.id === item.id);
        if (!prod) return;
        const subtotal = prod.precio * item.cantidad;
        total += subtotal;
        html += `
          <tr>
            <td><img src="${prod.imagen1}" width="60"></td>
            <td>${prod.nombre}</td>
            <td>${prod.categoria}</td>
            <td>$${prod.precio.toLocaleString('es-AR')}</td>
            <td>
              <div class="input-group input-group-sm">
                <button class="btn btn-outline-secondary btn-restar" data-id="${prod.id}">-</button>
                <input type="text" class="form-control text-center" value="${item.cantidad}" style="width:40px" readonly>
                <button class="btn btn-outline-secondary btn-sumar" data-id="${prod.id}">+</button>
              </div>
            </td>
            <td>$${subtotal.toLocaleString('es-AR')}</td>
            <td>
              <button class="btn btn-danger btn-sm btn-quitar" data-id="${prod.id}">&times;</button>
            </td>
          </tr>
        `;
      });
      html += `
          </tbody>
        </table>
        </div>
        <div class="text-end fs-4 fw-bold mt-3">
          Total: $${total.toLocaleString('es-AR')}
        </div>
      `;
      carritoLista.innerHTML = html;
      document.getElementById("btn-comprar").disabled = false;

      // Eventos para sumar/restar/quitar
      carritoLista.querySelectorAll(".btn-sumar").forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          const item = getCarritoLocal().find(p => p.id === id);
          setCantidadProducto(id, item.cantidad + 1);
          renderCarrito();
        };
      });
      carritoLista.querySelectorAll(".btn-restar").forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          const item = getCarritoLocal().find(p => p.id === id);
          if (item.cantidad > 1) {
            setCantidadProducto(id, item.cantidad - 1);
          } else {
            quitarDelCarritoLocal(id);
          }
          renderCarrito();
        };
      });
      carritoLista.querySelectorAll(".btn-quitar").forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          quitarDelCarritoLocal(id);
          renderCarrito();
        };
      });
    }

    // Comprar: Redirigir según estado de login
    document.getElementById("btn-comprar").addEventListener("click", () => {
      if (!auth.currentUser) {
        window.location.href = "login.html";
      } else {
        window.location.href = "comprar.html";
      }
    });

    // Render inicial
    renderCarrito();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>