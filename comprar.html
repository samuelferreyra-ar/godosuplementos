<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Finalizar compra</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
</head>
<body>
  <div class="container py-5">
    <h2 class="mb-4">Finalizar compra</h2>

    <div id="checkout-content" style="display:none;">
      <!-- RESUMEN DE PRODUCTOS -->
      <h4>Resumen de tu carrito</h4>
      <div id="checkout-resumen"></div>
      <hr>

      <!-- DIRECCIONES -->
      <h5>¿A dónde enviamos tu pedido?</h5>
      <div class="mb-3" id="checkout-direcciones"></div>

      <!-- MÉTODO DE PAGO -->
      <h5>Método de pago</h5>
      <div class="mb-4" id="checkout-metodo">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="metodoPago" id="pago-efectivo" value="Efectivo" checked>
          <label class="form-check-label" for="pago-efectivo">Efectivo</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="metodoPago" id="pago-transferencia" value="Transferencia">
          <label class="form-check-label" for="pago-transferencia">Transferencia bancaria</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="metodoPago" id="pago-tarjeta" value="Tarjeta de crédito">
          <label class="form-check-label" for="pago-tarjeta">Tarjeta de crédito</label>
        </div>
      </div>

      <button class="btn btn-success btn-lg w-100" id="btn-finalizar">Confirmar compra</button>
    </div>
    <div id="checkout-loader" class="text-center">
      Cargando...
    </div>
    <div id="checkout-msg" class="alert alert-success mt-4 d-none"></div>
  </div>

  <script type="module">
    import { getCarritoLocal } from './js/carrito.js';
    import { db, auth } from './js/firebase.js';
    import { doc, getDoc, setDoc, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const resumenDiv = document.getElementById("checkout-resumen");
    const direccionesDiv = document.getElementById("checkout-direcciones");
    const finalizarBtn = document.getElementById("btn-finalizar");
    const loaderDiv = document.getElementById("checkout-loader");
    const contentDiv = document.getElementById("checkout-content");
    const msgDiv = document.getElementById("checkout-msg");

    let usuario = null;
    let usuarioDB = null;
    let direcciones = [];
    let carrito = [];
    let productos = [];
    let total = 0;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      usuario = user;
      // Traer datos usuario y direcciones
      const userSnap = await getDoc(doc(db, "usuarios", user.uid));
      usuarioDB = userSnap.exists() ? userSnap.data() : null;
      direcciones = usuarioDB?.direcciones || [];

      // Traer productos del carrito y datos de los productos
      carrito = getCarritoLocal();
      if (carrito.length === 0) {
        loaderDiv.innerHTML = `<div class="alert alert-warning">Tu carrito está vacío.</div>`;
        return;
      }
      // Mejor aún, traigamos todos:
      let productosSnap = await getDocs(collection(db, "productos"));
      productos = [];
      productosSnap.forEach(doc => productos.push({id: doc.id, ...doc.data()}));

      renderCheckout();
    });

    function renderCheckout() {
      // RESUMEN DE PRODUCTOS
      total = 0;
      let html = `
        <table class="table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Precio</th>
              <th>Cant.</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
      `;
      carrito.forEach(item => {
        const prod = productos.find(p => p.id === item.id);
        if (!prod) return;
        const subtotal = prod.precio * item.cantidad;
        total += subtotal;
        html += `
          <tr>
            <td>${prod.nombre}</td>
            <td>$${prod.precio.toLocaleString('es-AR')}</td>
            <td>${item.cantidad}</td>
            <td>$${subtotal.toLocaleString('es-AR')}</td>
          </tr>
        `;
      });
      html += `
          </tbody>
        </table>
        <div class="fs-4 fw-bold text-end">Total: $${total.toLocaleString('es-AR')}</div>
      `;
      resumenDiv.innerHTML = html;

      // SELECCIÓN DE DIRECCIÓN
      let direcHTML = "";
      direcHTML += `
        <div class="form-check">
          <input class="form-check-input" type="radio" name="direccionEnvio" id="dir-sucursal" value="Sucursal" checked>
          <label class="form-check-label" for="dir-sucursal">Retirar por sucursal</label>
        </div>
      `;
      direcciones.forEach((dir, i) => {
        const texto = `${dir.calle} ${dir.numero}, ${dir.localidad}, ${dir.provincia}`;
        direcHTML += `
          <div class="form-check">
            <input class="form-check-input" type="radio" name="direccionEnvio" id="dir-${i}" value="${i}">
            <label class="form-check-label" for="dir-${i}">${texto}</label>
          </div>
        `;
      });
      direccionesDiv.innerHTML = direcHTML;

      // Ocultar loader, mostrar contenido
      loaderDiv.style.display = "none";
      contentDiv.style.display = "block";
    }

    finalizarBtn.addEventListener("click", async () => {
      finalizarBtn.disabled = true;
      msgDiv.classList.add("d-none");

      // Dirección elegida
      let direccionElegida = "Retiro en sucursal";
      const radioDir = document.querySelector('input[name="direccionEnvio"]:checked');
      if (radioDir && radioDir.value !== "Sucursal" && direcciones[radioDir.value]) {
        direccionElegida = direcciones[radioDir.value];
      }

      // Método de pago
      const metodoPago = document.querySelector('input[name="metodoPago"]:checked').value;

      // Generar número de pedido simple (puedes mejorarlo)
      const numeroPedido = "PD" + Date.now();

      // Crear documento de pedido
      const pedido = {
        numeroPedido,
        fecha: new Date().toISOString(),
        usuario: {
          uid: usuario.uid,
          nombre: usuarioDB?.nombre || "",
          email: usuario.email,
          telefono: usuarioDB?.telefono || ""
        },
        productos: carrito.map(item => {
          const prod = productos.find(p => p.id === item.id);
          return {
            id: prod.id,
            nombre: prod.nombre,
            cantidad: item.cantidad,
            precio: prod.precio
          };
        }),
        total,
        direccion: direccionElegida,
        metodoPago,
        estado: "Pendiente"
      };

      // Guardar en la colección "pedidos"
    await addDoc(collection(db, "pedidos"), pedido);

    msgDiv.textContent = "¡Tu pedido fue registrado con éxito! Nos pondremos en contacto para coordinar el pago y el envío.";
    msgDiv.classList.remove("d-none");
    finalizarBtn.disabled = true;

    // Limpia el carrito local
    localStorage.removeItem("carrito");

    // Redirigir después de 2 segundos
    setTimeout(() => {
    window.location.href = "index.html";
    }, 2000);

    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
